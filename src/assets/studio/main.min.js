"use strict";var cl=function(a){return console.log(a)},KMCModule=angular.module("KMCModule",["pascalprecht.translate","ngRoute","KMC.controllers","KMC.filters","KMC.services","KMC.directives","ngAnimate","LocalStorageModule","KMCmenu","JSONedit"]);KMCModule.config(["$routeProvider","$locationProvider","$httpProvider","$tooltipProvider","$translateProvider",function(a,b,c,d,e){e.useStaticFilesLoader({prefix:"i18n/",suffix:".json"}),e.preferredLanguage("en_US"),e.fallbackLanguage("en_US"),-1!=window.location.href.indexOf("debug"),e.useStorage("localStorageService"),d.options({placement:"right",appendToBody:!0,popupDelay:800}),d.setTriggers({customShow:"customShow"}),c.defaults.useXDomain=!0,delete c.defaults.headers.common["X-Requested-With"];var f,g=["$q","$injector",function(a,b){function c(a){return f=f||b.get("$http"),f.pendingRequests.length<1&&(e=e||b.get("requestNotificationChannel"),e.requestEnded()),a}function d(c){return logTime("httpRequest failed -"),f=f||b.get("$http"),f.pendingRequests.length<1&&(e=e||b.get("requestNotificationChannel"),e.requestEnded()),a.reject(c)}var e;return function(a){return e=e||b.get("requestNotificationChannel"),e.requestStarted(),a.then(c,d)}}];c.responseInterceptors.push(g),a.when("/login",{templateUrl:"view/login.html",controller:"LoginCtrl",resolve:{apiService:["api","apiService",function(a,b){return b}]}}),a.when("/list",{templateUrl:"view/list.html",controller:"PlayerListCtrl",resolve:{apiService:["api","apiService","localStorageService","$location",function(a,b,c,d){return h(a,b,c,d).then(function(){return b})}]}});var h=function(a,b,c,d){try{var e=window.parent.kmc;e&&e.vars&&e.vars.ks&&c.add("ks",e.vars.ks)}catch(f){cl("Could not located parent.kmc: "+f)}var g=c.get("ks");return g?(a.then(function(){b.setKs(g)}),a):(d.path("/login"),!1)};a.when("/edit/:id",{templateUrl:"view/edit.html",controller:"EditCtrl",reloadOnSearch:!1,resolve:{PlayerData:["PlayerService","$route","api","apiService","localStorageService","$location",function(a,b,c,d,e,f){var g=h(c,d,e,f);return g?g.then(function(){return a.getPlayer(b.current.params.id)}):void 0}],editProperties:"editableProperties"}}),a.when("/newByTemplate",{templateUrl:"view/new-template.html",controller:"PlayerCreateCtrl",reloadOnSearch:!1,resolve:{templates:["playerTemplates",function(a){return a.listSystem()}],userId:function(){return"1"}}}),a.when("/new",{templateUrl:"view/edit.html",controller:"EditCtrl",reloadOnSearch:!1,resolve:{api:["api","apiService","localStorageService","$location",function(a,b,c,d){return h(a,b,c,d)}],PlayerData:["api","PlayerService",function(a,b){return a.then(function(){return b.newPlayer()})}]}}),a.when("/logout",{resolve:{logout:["localStorageService","apiService","$location",function(a,b,c){a.isSupported()&&a.clearAll(),b.unSetks(),c.path("/login")}]}}),a.otherwise({resolve:{res:["api","apiService","localStorageService","$location",function(a,b,c,d){return h(a,b,c,d)?d.path("/list"):void 0}]}})}]).run(["$rootScope","$rootElement","$location",function(a,b,c){var d=new Date,e=!1;setTimeout(function(){window.localStorage.setItem("updateHash","true")},1e3),"undefined"!=typeof window.parent.kmc&&$("html").addClass("inKmc");var f=function(a){if(c.search().debug){var b=new Date,e=Math.abs(d.getTime()-b.getTime());cl(a+" "+Math.ceil(e/1e3)+"sec "+e%1e3+"ms")}};window.logTime=f,f("AppJsLoad"),a.constructor.prototype.$safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?this.$eval(a):this.$apply(a)},a.constructor.prototype.openTooltip=function(a){return $(a.target).trigger("customShow"),a.preventDefault(),a.stopPropagation(),!1},a.routeName="",a.$on("$routeChangeSuccess",function(){d=new Date;var b=c.url().split("/");e&&c.search({debug:!0}),-1!=b[1].indexOf("?")&&(b[1]=b[1].substr(0,b[1].indexOf("?"))),a.routeName=b[1]}),a.$on("$routeChangeStart",function(){e=c.search().debug?!0:!1});var g=window.parent.kmc;g&&g.vars.studio.showFlashStudio===!1&&$(".kmcSubNav").hide(),g&&g.vars.studio.showHTMLStudio===!1&&$("#htmlStudioBtn").hide()}]);var DirectivesModule=angular.module("KMC.directives",["ui.bootstrap","ui.select2","ui.sortable"]);DirectivesModule.directive("bindOnce",function(){return{scope:!0,link:function(a){setTimeout(function(){a.$destroy()},0)}}}),DirectivesModule.directive("onFinishRender",["$timeout","$compile",function(a,b){return{restrict:"A",link:function(c){c.$last===!0&&(a(function(){if(0===$(".playlistSetup").length&&$('div:contains("Playlist Configuration").panel').before('<div class="playlistSetup">Playlist setup:</div>'),0===$(".addPlugin").length){var a=b(angular.element('<p style="margin-top: 40px; margin-bottom: 36px"><button ng-click="addPlugin()" class="btn btn-default addPlugin"><i class="glyphicon glyphicon-plus">&nbsp;</i>Create New Plugin</button></p>'))(c);$('div:contains("UI Variables").panel').after(a)}if(0===$(".importPlugin").length){var d=b(angular.element('<p style="float: left; margin-right: 20px"><button ng-click="importPlugin()" class="btn btn-default importPlugin"><i class="glyphicon glyphicon-import">&nbsp;</i>Import Plugin</button></p>'))(c);$(".addPlugin").after(d)}},50),a(function(){$(".numeric").not(".allowNegative").numeric({allowMinus:!1,allowDecSep:!1}),$(".allowNegative").numeric({allowMinus:!0,allowDecSep:!1}),$(".float").numeric({allowMinus:!1,allowDecSep:!0}),$(".alpha").alphanum({allow:"-_=+,.!:;/@#$%^&*(){}[]|?~'",disallow:'"'}),$(".numbersArray").alphanum({allow:",.",allowUpper:!1,allowLower:!1,disallow:"-_=+\"!:;/@#$%^&*(){}[]|?~'"})},3e3))}}}]),DirectivesModule.directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),DirectivesModule.directive("timeago",[function(){return{restrict:"CA",link:function(a,b){"function"==typeof $.timeago&&a.$observe("timeago",function(c){if(c&&!isNaN(c)){var d=1e3*a.timestamp;b.text($.timeago(d))}})}}}]),DirectivesModule.directive("hiddenValue",[function(){return{template:'<input type="hidden" value="{{model}}"/>',scope:{model:"="},controller:function(a,b,c){c.initvalue&&(a.model=c.initvalue)},restrict:"EA"}}]),DirectivesModule.directive("sortOrder",["sortSvc",function(a){return{restrict:"EA",replace:!0,scope:{},templateUrl:"template/formcontrols/sortOrder.html",controller:["$scope",function(b){b.getObjects=function(){b.containers=a.getObjects()},b.getObjects(),a.sortScope=b,b.$on("sortContainersChanged",function(){b.getObjects()}),b.$watchCollection("containers",function(c,d){c!=d&&a.saveOrder(b.containers)}),b.sortableOptions={update:function(){cl(b.containers)},axis:"y"}}],link:function(){}}}]),DirectivesModule.directive("onbeforeunload",["$window","$filter","$location",function(a,b){function c(){var a,b,c=!1;for(a=0;a<e.length;a++)if(b=e[a],b.scope[b.name].$dirty){c=!0;break}return c?d:void 0}var d,e=[];return function(f,g){if("form"!==g[0].nodeName.toLowerCase())throw new Error("onbeforeunload directive must only be set on a angularjs form!");e.push({name:g[0].name,scope:f});try{d=b("translate")("onbeforeunload")}catch(h){d=""}var i=g[0].name;f.$watch(i+".$dirty",function(b,d){b&&b!=d&&(a.onbeforeunload=c)}),f.$on("$locationChangeSuccess",function(b,c,d){c.split("?")[0]!=d.split("?")[0]&&(a.ononbeforeunload=!1)}),f.$on("$destory",function(){a.ononbeforeunload=!1})}}]),DirectivesModule.directive("mcustomScrollbar",["$timeout",function(a){return{priority:0,scope:{},restrict:"AC",link:function(b,c,d){var e,f="99%";if("search"!=b.pagename){b.scroller=null;var g=b.$eval(d.mcustomScrollbar),h=null;b.$on("layoutChange",function(){h&&a.cancel(h),h=a(function(){b.scroller&&b.scroller.mCustomScrollbar("update"),h=null},300)});var i={horizontalScroll:!1,mouseWheel:!0,autoHideScrollbar:!0,contentTouchScroll:!0,theme:"dark",set_height:f,advanced:{autoScrollOnFocus:!1,updateOnBrowserResize:!0,updateOnContentResize:!1}};angular.extend(i,g);var j=function(){return a(function(){"function"==typeof $().mCustomScrollbar&&(b.scroller?b.scroller.mCustomScrollbar("update"):b.scroller=c.mCustomScrollbar(i))},1e3)};d.menuscroller?b.$on("menuChange",function(a,c){d.menuscroller==c?j():b.scroller&&(b.scroller.mCustomScrollbar("destroy"),b.scroller=null)}):e=j();var k=function(a){"block"==a?$("#tableHead").css("padding-right","18px"):$("#tableHead").css("padding-right","0px")};"list"==b.$root.routeName&&$("#tableHead").length&&e.then(function(){var d=$(c).find(".mCSB_scrollTools");b.scrollerCss=d.css("display"),a(function(){k(b.scrollerCss)},200),b.$watch(function(){return b.scrollerCss=d.css("display")},function(a){k(a)});var e;$(window).resize(function(){e&&a.cancel(e),e=a(function(){k(d.css("display")),e=null},200)})})}}}}]),angular.module("KMC.filters",["ngSanitize"]).filter("HTMLunsafe",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]).filter("timeago",function(){return function(a){if("function"!=typeof $.timeago||isNaN(a))return a;var b=1e3*a;return $.timeago(b)}}).filter("range",function(){return function(a){var b,c;switch(a.length){case 1:b=0,c=parseInt(a[0])-1;break;case 2:b=parseInt(a[0]),c=parseInt(a[1]);break;default:return a}for(var d=[],e=b;c>=e;e++)d.push(e);return d}}).filter("startFrom",function(){return function(a,b){return a?(b=+b,a.slice(b)):[]}});var KMCMenu=angular.module("KMCmenu",["ui.bootstrap","ngSanitize","ui.select2","angularSpectrumColorpicker"]);KMCMenu.controller("EditCtrl",["$scope","$http","$timeout","PlayerData","PlayerService","apiService","editableProperties","localStorageService","$routeParams","$modal","$location","requestNotificationChannel","select2Svc","utilsSvc",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){a.playerData=angular.copy(d),a.isIE8=window.ie8,a.invalidProps=[],a.dataChanged=!1;var o=a.playerData.height/a.playerData.width;a.aspectRatio=o==9/16?"wide":.75==o?"narrow":"custom",a.newPlayer=!i.id,a.menuOpen=!0,"undefined"==typeof a.playerData.autoUpdate&&(a.playerData.autoUpdate=-1!==a.playerData.html5Url.indexOf("{latest}")),a.autoPreview=h.get("autoPreview")?"true"==h.get("autoPreview"):!1,a.simulateMobile=!1,a.setAutoPreview=function(){h.set("autoPreview",!a.autoPreview)},a.setSimulateMobile=function(){setTimeout(function(){a.refreshPlayer()},0)},window.parent.kmc&&window.parent.kmc.vars.studio.showFlashStudio===!1&&$(".menuFooter").css("bottom","1px"),window.parent.studioDataChanged=!1,a.userEntries=[],a.selectedEntry="",a.entriesTypeSelector="Entries",f.listMedia().then(function(b){for(var c=0;c<b.objects.length;c++)a.userEntries.push({id:b.objects[c].id,text:b.objects[c].name});-1!==a.playerData.tags.indexOf("player")&&a.selectDefaultEntry(a.userEntries)}),a.entriesSelectBox=m.getConfig(a.userEntries,f.searchMedia),a.userPlaylists=[],f.listPlaylists().then(function(b){for(var c=0;c<b.objects.length;c++)a.userPlaylists.push({id:b.objects[c].id,text:b.objects[c].name});-1!==a.playerData.tags.indexOf("playlist")&&(a.selectDefaultEntry(a.userPlaylists,function(){a.setPlaylistEntry(a.selectedEntry.id,a.selectedEntry.text)}),a.entriesTypeSelector="Playlist")}),a.playlistSelectBox=m.getConfig(a.userPlaylists,f.searchPlaylists),a.setEntriesType=function(b){a.entriesTypeSelector=b,"Entries"===b?(a.playerData.config.plugins.playlistAPI&&a.playerData.config.plugins.playlistAPI.plugin&&a.setPluginEnabled("playlistAPI",!1),a.selectDefaultEntry(a.userEntries)):((!a.playerData.config.plugins.playlistAPI||a.playerData.config.plugins.playlistAPI&&!a.playerData.config.plugins.playlistAPI.plugin)&&a.setPluginEnabled("playlistAPI",!0),a.selectDefaultEntry(a.userPlaylists),a.setPlaylistEntry(a.selectedEntry.id,a.selectedEntry.text)),a.refreshPlayer()},a.setPlaylistEntry=function(b,c){"Playlist"===a.entriesTypeSelector&&a.playerData.config.plugins.playlistAPI&&a.playerData.config.plugins.playlistAPI.plugin&&(a.playerData.config.plugins.playlistAPI.kpl0Id=b,a.playerData.config.plugins.playlistAPI.kpl0Name=c,a.$broadcast("setPlaylistEvent",[b,c]))},a.selectDefaultEntry=function(b,c){if(h.get("defaultEntry")){for(var d=h.get("defaultEntry"),e=!1,f=0;f<b.length;f++)b[f].id==d.id&&(e=!0,a.selectedEntry=d);e||(a.selectedEntry=b[0])}else a.selectedEntry=b[0];c&&c()},a.toggleMenu=function(){a.menuOpen=!a.menuOpen},g.then(function(b){b=angular.copy(b),a.mergePlayerData(b),a.templatesToLoad=0,a.propertiesSearch=[],a.menuData=[{label:"Menu Search",description:"Search allows you to find any plugin property within the menu.",icon:"TabSearch",properties:[{type:"search",model:"menuProperties"}]}];var c=0;for(var d in b){c++;var e={label:b[d].label,description:b[d].description,icon:b[d].icon,properties:[]},f=b[d].children,g=[],h=-1;for(var i in f){var j=f[i];if(void 0===j.children)a.addPropertyToCategory(e,c,j);else{h++,a.propertiesSearch.push({label:j.label,categoryIndex:c,accIndex:h,id:"accHeader"+c+"_"+h});var k={enabled:j.enabled,label:j.label,description:j.description,isopen:!1,model:j.model,id:"accHeader"+c+"_"+h};k.properties=[];var m={type:"tabs",children:[]};if(j.sections){a.templatesToLoad++;for(var n=0;n<j.sections.tabset.length;n++)m.children.push(j.sections.tabset[n])}for(var o=0;o<j.children.length;o++)if(void 0!==j.children[o].filter&&(j.children[o].initvalue=a.getFilter(j.children[o].initvalue,j.children[o].filter)),a.templatesToLoad++,j.sections&&j.children[o].section)for(var p=0;p<m.children.length;p++)j.children[o].section==m.children[p].key&&(m.children[p].children.push($.extend(j.children[o],{id:"prop"+a.templatesToLoad})),a.propertiesSearch.push({label:j.children[o].label+" ("+j.label+")",categoryIndex:c,accIndex:h,tabIndex:p,id:"prop"+a.templatesToLoad}));else a.propertiesSearch.push({label:j.children[o].label+" ("+j.label+")",categoryIndex:c,accIndex:h,id:"prop"+a.templatesToLoad}),k.properties.push($.extend(j.children[o],{id:"prop"+a.templatesToLoad}));j.sections&&k.properties.push(m),g.push(k)}}e.plugins=g,a.menuData.push(e)}for(var q in a.playerData.config.plugins){var r=angular.copy(a.playerData.config.plugins[q]);r.custom&&(delete r.custom,delete r.enabled,delete r.plugin,a.addCustomPlugin(q,r))}for(var s=2;s<a.menuData.length;s++)a.menuData[s].pluginsNotLoaded=angular.copy(a.menuData[s].plugins),delete a.menuData[s].plugins;a.selectedCategory=a.menuData[1].label,l.requestEnded("edit"),a.refreshPlayer()}),a.addPropertyToCategory=function(b,c,d){a.templatesToLoad++,a.propertiesSearch.push({label:d.label,categoryIndex:c,accIndex:-1,id:"prop"+a.templatesToLoad}),b.properties.push($.extend(d,{id:"prop"+a.templatesToLoad}))},a.categorySelected=function(b){a.selectedCategory=b,"Menu Search"==b&&c(function(){$("#searchField").focus();for(var b=2;b<a.menuData.length;b++)void 0!==a.menuData[b].pluginsNotLoaded&&(a.menuData[b].plugins=angular.copy(a.menuData[b].pluginsNotLoaded),delete a.menuData[b].pluginsNotLoaded)},50,!0),c(function(){for(var c=2;c<a.menuData.length;c++)a.menuData[c].label==b&&void 0!==a.menuData[c].pluginsNotLoaded&&(a.menuData[c].plugins=angular.copy(a.menuData[c].pluginsNotLoaded),delete a.menuData[c].pluginsNotLoaded)},50,!0)},a.menuLoaded=!1,a.templatesLoaded=0,a.$on("$includeContentLoaded",function(){a.templatesLoaded++,a.templatesLoaded==a.templatesToLoad&&(a.menuLoaded=!0,c(function(){$("#searchField").focus()},100))}),a.togglePlugin=function(b,d){d.stopPropagation(),b.enabled?(a.removeValidation(b),delete a.playerData.config.plugins[b.model]):a.addValidation(b),"playlistAPI"==b.model&&(b.enabled?(a.entriesTypeSelector="Entries",a.selectDefaultEntry(a.userEntries)):(a.entriesTypeSelector="Playlist",a.selectDefaultEntry(a.userPlaylists))),a.dataChanged=!0,window.parent.studioDataChanged=!0,c(function(){a.refreshPlayer()},0,!0)},a.removeValidation=function(b){for(var c=0;c<b.properties.length;c++){delete b.properties[c].invalidTooltip;var d=b.properties[c].id;-1!=$.inArray(d,a.invalidProps)&&a.invalidProps.splice(a.invalidProps.indexOf(d),1)}},a.addValidation=function(b){for(var c=0;c<b.properties.length;c++)a.validate(b.properties[c])},a.searchProperty=function(b){if(a.selectedCategory=a.menuData[b.categoryIndex].label,-1!=b.accIndex&&(a.menuData[b.categoryIndex].plugins[b.accIndex].isopen=!0),b.tabIndex&&-1!=b.tabIndex)for(var c=a.menuData[b.categoryIndex].plugins[b.accIndex].properties,d=0;d<c.length;d++)"tabs"==c[d].type&&(c[d].children[b.tabIndex].active=!0);var e=0,f=setInterval(function(){var a="visible"==$("#"+b.id).css("visibility")?"hidden":"visible";$("#"+b.id).css("visibility",a),e++,6==e&&clearInterval(f)},250)},a.lastRefreshID="",a.propertyChanged=function(b,c){if(b.selectedEntry&&b.selectedEntry.id&&0===b.model.indexOf("~"))return a.selectedEntry=b.selectedEntry,h.set("defaultEntry",b.selectedEntry),a.setPlaylistEntry(b.selectedEntry.id,b.selectedEntry.text),a.refreshPlayer(),void 0;if(b["player-refresh"]&&-1!=b["player-refresh"].indexOf(".")){var d=b["player-refresh"].split(".")[0],e=b["player-refresh"].split(".")[1],f=document.getElementById("kVideoTarget");return f.setKDPAttribute(d,e,b.initvalue),void 0}if("autoUpdate"===b.model)return a.playerData.autoUpdate=b.initvalue,void 0;if(a.dataChanged=!0,window.parent.studioDataChanged=!0,a.validate(b),b.aspectRatio&&"custom"!==b.aspectRatio){var g="wide"==b.aspectRatio?9/16:.75;a.playerData.height=parseInt(a.playerData.width*g)}a.refreshNeeded=b["player-refresh"]!==!1,c!==!1&&a.refreshNeeded&&a.autoPreview&&("enter"==c&&(a.lastRefreshID=b.id),"blur"==c&&a.lastRefreshID==b.id?a.lastRefreshID="":a.refreshPlayer())},a.validate=function(b){b.invalidTooltip&&delete b.invalidTooltip,-1!=$.inArray(b.id,a.invalidProps)&&a.invalidProps.splice(a.invalidProps.indexOf(b.id),1),b.min&&b.initvalue<b.min&&(b.invalidTooltip="Value must be equal or bigger than "+b.min),b.max&&parseInt(b.initvalue)>parseInt(b.max)&&(b.invalidTooltip="Value must be equal or less than "+b.max),b.require&&""===b.initvalue&&(b.invalidTooltip="This field is required"),b.invalidTooltip&&(a.isValid=!1,a.invalidProps.push(b.id))},a.checkPlayerRefresh=function(){return a.refreshNeeded},a.refreshPlayer=function(){a.refreshNeeded=!1,""!==a.selectedEntry?a.renderPlayer():a.intervalID=setInterval(function(){""!==a.selectedEntry&&(clearInterval(a.intervalID),a.renderPlayer())},100)},a.renderPlayer=function(){a.updatePlayerData(),a.$broadcast("beforeRenderEvent"),$(".onpagePlaylistInterface").remove(),$("#kVideoTarget").width(a.playerData.width),$("#kVideoTarget").height(a.playerData.height);for(var b in a.playerData.config.plugins)a.playerData.config.plugins[b].enabled===!0&&(a.playerData.config.plugins[b].plugin=!0);a.setPlaylistEntry(a.selectedEntry.id,a.selectedEntry.text);var c={};a.playerData.config.enviornmentConfig&&a.playerData.config.enviornmentConfig.localizationCode&&angular.extend(c,{localizationCode:a.playerData.config.enviornmentConfig.localizationCode}),a.simulateMobile&&angular.extend(c,{"EmbedPlayer.SimulateMobile":!0}),delete a.playerData.config.enviornmentConfig,angular.extend(c,{jsonConfig:angular.toJson(a.playerData.config)}),window.parent.kmc&&window.parent.kmc.vars.ks&&angular.extend(c,{ks:window.parent.kmc.vars.ks}),a.isIE8&&angular.extend(c,{wmode:"transparent"});var d=a.selectedEntry.id?a.selectedEntry.id:a.selectedEntry;e.renderPlayer(a.playerData.partnerId,a.playerData.id,c,d)},a.mergePlayerData=function(b){if($.isArray(a.playerData.config.uiVars)){for(var c={},d=0;d<a.playerData.config.uiVars.length;d++)c[a.playerData.config.uiVars[d].key]=a.playerData.config.uiVars[d].value;a.playerData.config.uiVars=c}a.excludedUiVars=["autoPlay","autoMute","adsOnReplay","enableTooltips","EmbedPlayer.EnableMobileSkin"],a.playerData.vars=[];var e;for(e in a.playerData.config.uiVars)-1===a.excludedUiVars.indexOf(e)&&a.playerData.vars.push({label:e,value:a.playerData.config.uiVars[e]});for(e in a.playerData.config.uiVars)-1!==e.indexOf(".")&&(a.playerData.config.uiVars[e.split(".")[0]]={enabled:!0},a.playerData.config.uiVars[e.split(".")[0]][e.split(".")[1]]=a.playerData.config.uiVars[e],delete a.playerData.config.uiVars[e]);if(a.playerData.config.plugins&&a.playerData.config.plugins.playlistAPI)for(var f=a.playerData.config.plugins.playlistAPI,g=b.lookAndFeel.children.playlistAPI.children,h=1;f["kpl"+h+"Id"];){for(var i=!1,j=0;j<g.length;j++)-1!==g[j].model.indexOf("kpl"+h+"Id")&&(i=!0);i||(g.push({model:"config.plugins.playlistAPI.kpl"+h+"Id",type:"hiddenValue"}),g.push({model:"config.plugins.playlistAPI.kpl"+h+"Name",type:"hiddenValue"})),h++}for(var k in b){var l=b[k].children;if($.isArray(l))a.getPlayerProperties(l);else for(var m in l)l[m].children?(l[m].model=m,l[m].enabled=a.playerData.config.plugins[m]||"uiVars"==m?!0:!1,a.getPlayerProperties(l[m].children)):a.getPlayerProperties([l[m]])}},a.getPlayerProperties=function(b){for(var c=0;c<b.length;c++)if(b[c].model&&-1==b[c].model.indexOf("~")){var d=a.getDataForModel(a.playerData,b[c].model,b[c].filter);null!==d&&(b[c].initvalue=d)}},a.getDataForModel=function(b,c,d){for(var e=angular.copy(b),f=c.split("."),g=0;g<f.length;g++){if(void 0===e[f[g]])return null;e=e[f[g]]}return void 0!==d?a.getFilter(e,d):e},a.getFilter=function(a,b){if("companions"==b&&!$.isArray(a)){var c=a.split(";");a=[];for(var d=0;d<c.length;d++)-1!=c[d].indexOf(":")&&a.push({label:c[d].substr(0,c[d].indexOf(":")),width:c[d].split(":")[1],height:c[d].split(":")[2]})}return a},a.updatePlayerData=function(){for(var b=1;b<a.menuData.length;b++)if(void 0!==a.menuData[b].properties&&a.setPlayerProperties(a.menuData[b].properties),void 0!==a.menuData[b].plugins||void 0!==a.menuData[b].pluginsNotLoaded)for(var c=void 0!==a.menuData[b].plugins?"plugins":"pluginsNotLoaded",d=0;d<a.menuData[b][c].length;d++)if(a.menuData[b][c][d].enabled===!0){var e=a.menuData[b][c][d];a.setPlayerProperties(e.properties),e.custom&&a.updateCustomPlugins(e.model)}var f;for(f in a.playerData.config.uiVars)if("object"==typeof a.playerData.config.uiVars[f]){var g,h;for(var i in a.playerData.config.uiVars[f])"enabled"!=i&&(g=f+"."+i,h=a.playerData.config.uiVars[f][i]);delete a.playerData.config.uiVars[f],a.playerData.config.uiVars[g]=h}for(var j=0;j<a.playerData.vars.length;j++)-1===a.excludedUiVars.indexOf(a.playerData.vars[j].label)&&""!==a.playerData.vars[j].label&&""!==a.playerData.vars[j].value&&(a.playerData.config.uiVars[a.playerData.vars[j].label]=n.str2val(a.playerData.vars[j].value));var k=[];for(f in a.playerData.config.uiVars){var l=!1;-1!==a.excludedUiVars.indexOf(f)&&(l=!0);for(var m=0;m<a.playerData.vars.length;m++)a.playerData.vars[m].label===f&&(l=!0);l?k.push({key:f,value:a.playerData.config.uiVars[f],overrideFlashvar:!1}):delete a.playerData.config.uiVars[f]}a.playerData.config.uiVars=k},a.setPlayerProperties=function(b){for(var c=0;c<b.length;c++)if("tabs"==b[c].type)for(var d=0;d<b[c].children.length;d++)for(var e=0;e<b[c].children[d].children.length;e++)a.setDataForModel(b[c].children[d].children[e]);else a.setDataForModel(b[c])},a.setDataForModel=function(b){if(b.model&&-1==b.model.indexOf("~")&&"readonly"!=b.type)for(var c=b.model.split("."),d=a.playerData,e=0;e<c.length;e++){var f=c[e];e==c.length-1&&void 0!==b.initvalue?d[f]=b.filter?a.setFilter(b.initvalue,b.filter):b.initvalue:(e!=c.length-2||d[f]||(d[f]=b.custom?{custom:!0,enabled:!0}:{enabled:!0}),d[f]&&(d=d[f]))}},a.setFilter=function(a,b){var c="";if("companions"==b){for(var d=0;d<a.length;d++)c+=a[d].label+":"+a[d].width+":"+a[d].height+";";return c.substr(0,c.length-1)}return"entry"==b?a.id?a.id:a:void 0},a.backToList=function(){if(a.dataChanged){var b=n.confirm("Navigation confirmation","You are about to leave this page without saving, are you sure you want to discard the changes?","Continue");b.result.then(function(a){a&&k.url("/list")})}else k.url("/list")},a.save=function(){a.invalidProps.length>0?n.alert("Save Player Settings","Some plugin features values are invalid. The player cannot be saved."):(a.updatePlayerData(),a.dataChanged=!1,window.parent.studioDataChanged=!1,a.playerData.tags=a.playerData.config.plugins.playlistAPI&&a.playerData.config.plugins.playlistAPI.plugin?"html5studio,playlist":"html5studio,player",e.savePlayer(a.playerData).then(function(){h.remove("tempPlayerID"),f.setCache(!1),n.alert("Save Player Settings","Player Saved Successfully")},function(a){n.alert("Player save failure",a)}))},a.setPluginEnabled=function(b,c){for(var d in a.menuData){var e=a.menuData[d].pluginsNotLoaded?a.menuData[d].pluginsNotLoaded:a.menuData[d].plugins;if(e&&e.length>0)for(var f=0;f<e.length;f++)e[f].model===b&&(e[f].enabled=c,a.playerData.config.plugins[b]&&!c&&delete a.playerData.config.plugins[b])}},a.addPlugin=function(){var b=n.userInput("Add custom plugin","Plugin Name:","Add",{width:"50%"});c(function(){$(".userInput").alphanum({allowSpace:!1})},50),b.result.then(function(b){b&&a.addCustomPlugin(b,{})})},a.importPlugin=function(){var b,c=n.userInput("Import plugin","Plugin Configuration String:","Import",{width:"100%"});c.result.then(function(c){if(c){var d=c.split("&");if(-1==d[0].indexOf("=")){for(var e=d[0],f={},g=1;g<d.length;g++)b=d[g].split("="),f[b[0]]=b[1];a.addCustomPlugin(e,f)}else for(var h=0;h<d.length;h++){b=d[h].split("=");for(var i=0;i<a.menuData.length;i++)if("Plugins"===a.menuData[i].label)for(var j=0;j<a.menuData[i].plugins.length;j++)if("uiVars"===a.menuData[i].plugins[j].model){var k=a.menuData[i].plugins[j].properties[0].initvalue;k.push({label:b[0],value:b[1]})}}}})},a.addCustomPlugin=function(b,c){for(var d=0;d<a.menuData.length;d++)"Plugins"===a.menuData[d].label&&a.menuData[d].plugins.push({description:b+" custom plugin.",enabled:!0,isopen:$.isEmptyObject(c)?!0:!1,custom:!0,label:b+" custom plugin",model:b,properties:[{initvalue:c,allowComplexTypes:!1,custom:!0,helpnote:"Configuration options",label:"Configuration options",model:"config.plugins."+b+".config",type:"json"}]})},a.updateCustomPlugins=function(b){if(a.playerData.config.plugins[b]&&a.playerData.config.plugins[b].config){var c=a.playerData.config.plugins[b].config;a.playerData.config.plugins[b]={enabled:!0,custom:!0,plugin:!0};for(var d in c)a.playerData.config.plugins[b][d]=c[d];delete a.playerData.config.plugins[b].config}}}]),angular.module("KMCModule").controller("LoginCtrl",["$scope","apiService","$location","localStorageService","requestNotificationChannel","$filter",function(a,b,c,d,e,f){e.requestEnded("list"),a.formError=!0,a.formHelpMsg=f("translate")("You must login to use this application"),a.email="",a.pwd="",a.login=function(){b.doRequest({service:"user",action:"loginbyloginid",loginId:a.email,password:a.pwd}).then(function(a){d.isSupported()&&d.add("ks",a),b.setKs(a),c.path("/list")},function(b){a.formError=!0,a.formHelpMsg=b})}}]),angular.module("KMC.controllers",[]).controller("ModalInstanceCtrl",["$scope","$modalInstance","settings",function(a,b,c){a.title="",a.message="",a.buttons=[{result:!1,label:"Cancel",cssClass:"btn-default"},{result:!0,label:"OK",cssClass:"btn-primary"}],a.close=function(a){b.close(a)},a.cancel=function(){b.dismiss("cancel")},angular.extend(a,c)}]).controller("ModalInstanceInputCtrl",["$scope","$modalInstance","settings",function(a,b,c){a.userInput="",a.title="",a.message="",a.buttons=[{result:!1,label:"Cancel",cssClass:"btn-default"},{result:!0,label:"OK",cssClass:"btn-primary"}],a.close=function(a){a=a?this.userInput:!1,b.close(a)},a.cancel=function(){b.dismiss("cancel")},angular.extend(a,c)}]),KMCMenu.controller("entrySelectorCtrl",["$scope",function(a){a.getLabel=function(b,c){for(var d="playlistSelectBox"==c?a.userPlaylists:a.userEntries,e=0;e<d.length;e++)if(d[e].id===b)return d[e].text;return b}}]),KMCMenu.controller("jsonCtrl",["$scope",function(a){a.$on("jsonChangeEvent",function(){a.propertyChanged({"player-refresh":"true"},!1)})}]),KMCMenu.controller("keyValuePairsCtrl",["$scope",function(a){if(a.keyValuePairs=[],a.playerData.config.plugins&&a.playerData.config.plugins[a.plugin.model]){var b=a.playerData.config.plugins[a.plugin.model];for(var c in b)"plugin"!==c&&"enabled"!==c&&"keyValuePairs"!==c&&a.keyValuePairs.push({key:c,value:b[c]})}a.$on("beforeRenderEvent",function(){a.updateKeyValueData()}),a.updateData=function(){a.updateKeyValueData()},a.updateKeyValueData=function(){if(a.playerData.config.plugins&&a.playerData.config.plugins[a.plugin.model]){var b=a.playerData.config.plugins[a.plugin.model];for(var c in b)"plugin"!==c&&"enabled"!==c&&delete b[c];for(var d=0;d<a.keyValuePairs.length;d++)b[a.keyValuePairs[d].key.toString()]=a.keyValuePairs[d].value.toString()}}}]),angular.module("KMCModule").controller("PlayerCreateCtrl",["$scope","$filter","templates","userId","playerTemplates",function(a,b,c,d,e){a.title=b("translate")("New player - from template"),a.templates=c.data,a.templateType="system",a.userId=d,a.loading=!1,a.$watch("templateType",function(b,d){b!=d&&("user"==b?(a.loading=!0,e.listUser(a.userID).success(function(b){a.templates=b,a.loading=!1})):(a.loading=!0,a.templates=c.data,a.loading=!1))}),a.makeTooltip=function(b){var c=a.templates[b];return c&&"undefined"!=typeof c.settings&&"undefined"!=typeof c.settings.name?c.settings.name+"<br/>"+c.id+"<br/> Any information you will decide to show":void 0}}]),angular.module("KMCModule").controller("PlayerListCtrl",["apiService","loadINI","$location","$rootScope","$scope","$filter","$modal","$timeout","$log","$compile","$window","localStorageService","requestNotificationChannel","PlayerService","$q","utilsSvc",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){m.requestStarted("list"),d.lang="en-US";var q=function(a){var b="";return b=-1!==a.indexOf("{latest}")?"latest":a.substring(a.lastIndexOf("/v")+2,a.indexOf("/mwEmbedLoader.php"))};e.search="",e.searchSelect2Options={},e.currentPage=1,e.maxSize=parseInt(l.get("listSize"))||10,e.$watch("maxSize",function(a,b){a!=b&&(l.set("listSize",a),e.$broadcast("layoutChange"))}),e.triggerLayoutChange=function(){e.$broadcast("layoutChange")},e.uiSelectOpts={width:"60px",minimumResultsForSearch:-1};var r=null;try{var s=window.parent.kmc;s&&s.vars&&s.vars.studio.config&&(r=s.vars.studio.config,e.UIConf=angular.fromJson(r))}catch(t){i.error("Could not located parent.kmc: "+t)}if(r||b.getINIConfig().success(function(a){e.UIConf=a}),n.getKDPConfig(),l.get("tempPlayerID")){var u={service:"uiConf",action:"delete",id:l.get("tempPlayerID")};a.doRequest(u).then(function(){l.remove("tempPlayerID")})}var v={"filter:tagsMultiLikeOr":"kdp3,html5studio","filter:orderBy":"-updatedAt","filter:objTypeIn":"1,8","filter:objectType":"KalturaUiConfFilter","filter:creationModeEqual":"2",ignoreNull:"1","responseProfile:objectType":"KalturaDetachedResponseProfile","responseProfile:type":"1","responseProfile:fields":"id,name,html5Url,createdAt,updatedAt,tags","page:objectType":"KalturaFilterPager","pager:pageIndex":"1","pager:pageSize":"999",service:"uiConf",action:"list"};a.doRequest(v).then(function(a){e.data=a.objects,e.calculateTotalItems(),n.cachePlayers(a.objects),m.requestEnded("list"),setTimeout(function(){e.triggerLayoutChange()},300)}),e.filtered=f("filter")(e.data,e.search)||e.data,e.calculateTotalItems=function(){e.filtered?e.totalItems=e.filtered.length:e.data&&(e.totalItems=e.data.length)},e.requiredVersion=n.getRequiredVersion(),e.sort={sortCol:"createdAt",reverse:!0},e.sortBy=function(a){e.sort.sortCol=a,e.sort.reverse=!e.sort.reverse},e.checkV2Upgrade=function(a){var b=q(a.html5Url);return!e.checkVersionNeedsUpgrade(a)&&window.MWEMBED_VERSION!==b&&"latest"!==b},e.checkVersionNeedsUpgrade=function(a){var b=q(a.html5Url)[0];return"1"==b},e.checkOldPlaylistPlayer=function(a){var b=q(a.html5Url)[0];return"1"==b&&-1!==a.tags.indexOf("playlist")},e.showSubTitle=!0,e.getThumbnail=function(a){return"undefined"!=typeof a.thumbnailUrl?a.thumbnailUrl:e.defaultThumbnailUrl},e.defaultThumbnailUrl="img/mockPlayerThumb.png";var w;e.$watch("search",function(a,b){e.showSubTitle=a,a.length>0?e.title=f("translate")("search for")+' "'+a+'"':b&&(e.title=f("translate")("Players list")),w&&h.cancel(w),w=h(function(){e.triggerLayoutChange(),e.calculateTotalItems(),w=null},100)}),e.oldVersionEditText=f("translate")("This player must be updated before editing. <br/>Some features and design may be lost."),e.oldPlaylistEditText=f("translate")("Playlists created in Flash Studio cannot be edited in Universal Studio.<br>Please use Flash Studio to edit this player.");
var x=function(a){m.requestStarted("edit"),c.path("/edit/"+a)};e.goToEditPage=function(a,b){if(b&&b.preventDefault(),!e.checkVersionNeedsUpgrade(a)&&!e.checkOldPlaylistPlayer(a))return x(a.id),!1;var c,d;e.checkVersionNeedsUpgrade(a)&&(c=f("translate")("This player must be updated before editing. <br/>Some features and design may be lost."),d=[{result:!1,label:"Cancel",cssClass:"btn-default"},{result:!0,label:"Update",cssClass:"btn-primary"}]),e.checkOldPlaylistPlayer(a)&&(c=f("translate")("Playlists created in Flash Studio cannot be edited in Universal Studio.<br>Please use Flash Studio to edit this player."),d=[{result:!1,label:"OK",cssClass:"btn-default"}]);var h=g.open({templateUrl:"templates/message.html",controller:"ModalInstanceCtrl",resolve:{settings:function(){return{title:"Edit confirmation",message:c,buttons:d}}}});h.result.then(function(b){b&&e.update(a).then(function(){x(a.id)})},function(){return i.info("edit when outdated modal dismissed at: "+new Date)})},e.newPlayer=function(){c.path("/new")},e.duplicate=function(a){n.clonePlayer(a).then(function(a){e.data.unshift(a[1]),n.cachePlayers(e.data),e.goToEditPage(a[1])})},e.deletePlayer=function(a){var b=g.open({templateUrl:"templates/message.html",controller:"ModalInstanceCtrl",resolve:{settings:function(){return{title:"Delete confirmation",message:"Are you sure you want to delete the player?"}}}});b.result.then(function(b){b&&n.deletePlayer(a.id).then(function(){e.data.splice(e.data.indexOf(a),1),e.triggerLayoutChange()},function(a){g.open({templateUrl:"templates/message.html",controller:"ModalInstanceCtrl",resolve:{settings:function(){return{title:"Delete failure",message:a}}}})})},function(){i.info("Delete modal dismissed at: "+new Date)})},e.upgrade=function(a){var b=o.defer(),c=q(a.html5Url),d=window.MWEMBED_VERSION,e='This will update the player "'+a.name+'" (ID: '+a.id+").";e+="<br>Current player version: "+c,e+="<br>Update to version: "+d+'<a href="https://github.com/kaltura/mwEmbed/releases/tag/v'+d+'" target="_blank"> (release notes)</a>';var f=p.confirm("Updating confirmation",e,"Update");return f.result.then(function(c){if(c){var d=a.html5Url.substr(0,a.html5Url.lastIndexOf("/v")+2)+window.MWEMBED_VERSION+"/mwEmbedLoader.php";n.playerUpgrade(a,d).then(function(){a.html5Url=d,b.resolve("update finished successfully"),p.alert("Player Updated","The player was updated successfully."),$("#kcms",window.parent.document).length>0&&$("#kcms",window.parent.document)[0].refreshPlayersList()},function(a){p.alert("Update player failure",a),b.reject("update canceled")})}else i.info("Update player dismissed at: "+new Date),b.reject("update canceled")}),b.promise},e.update=function(a){var b=o.defer(),c=(a.html5Url.split("/v")[1].split("/")[0],"<span>"+f("translate")("Do you want to upgrade this player?<br>Some features and design may be lost.")+"</span>"),d=-1!==a.tags.indexOf("playlist");d&&(c+="<br><span><b>Note:</b> Playlist configuration will not be updated.<br>Please re-configure your playlist plugin after this upgrade.</span>");var e=a.html5Url.substr(0,a.html5Url.lastIndexOf("/v")+2)+window.MWEMBED_VERSION+"/mwEmbedLoader.php",g=p.confirm("Upgrade confirmation",c,"Upgrade");return g.result.then(function(c){c&&n.playerUpdate(a,e,d).then(function(c){a.config=angular.fromJson(c.config),a.html5Url=e,a.tags=d?"html5studio,playlist":"html5studio,player",b.resolve("upgrade finished successfully"),$("#kcms",window.parent.document).length>0&&$("#kcms",window.parent.document)[0].refreshPlayersList()},function(a){p.alert("Update player failure",a),b.reject("upgrade canceled")})},function(){i.info("Update player dismissed at: "+new Date),b.reject("upgrade canceled")}),b.promise}}]),KMCMenu.controller("playlistCtrl",["$scope","$modal","utilsSvc",function(a){a.additionalPlaylists=[];for(var b=0;b<a.plugin.properties.length;b++){var c=a.plugin.properties[b];if(0===c.model.indexOf("config.plugins.playlistAPI.kpl")&&c.model.indexOf("Id")===c.model.length-2){var d=c.initvalue,e=a.plugin.properties[b+1].initvalue,f=-1===c.model.indexOf("config.plugins.playlistAPI.kpl0Id");a.additionalPlaylists.push({id:d,name:e,editable:f})}}a.playerData.config.plugins&&a.playerData.config.plugins.playlistAPI&&(a.additionalPlaylists[0]={id:a.playerData.config.plugins.playlistAPI.kpl0Id,name:a.playerData.config.plugins.playlistAPI.kpl0Name,editable:!1}),a.$on("setPlaylistEvent",function(b,c){a.additionalPlaylists[0]={id:c[0],name:c[1],editable:!1}}),a.addPlaylist=function(b){a.additionalPlaylists.push({id:"",name:"",editable:!0}),a.propertyChanged(b,!0)},a.deletePlaylist=function(b,c){a.additionalPlaylists.splice(b,1),a.updatePlaylist(c,!0)},a.updatePlaylist=function(b,c){for(var d=a.plugin.properties.length-1;d>=0;d--){var e=a.plugin.properties[d];0===e.model.indexOf("config.plugins.playlistAPI.kpl")&&a.plugin.properties.splice(d,1)}for(var f=0;f<a.additionalPlaylists.length;f++)a.plugin.properties.push({model:"config.plugins.playlistAPI.kpl"+f+"Id",initvalue:a.additionalPlaylists[f].id,type:"hiddenValue"}),a.plugin.properties.push({model:"config.plugins.playlistAPI.kpl"+f+"Name",initvalue:a.additionalPlaylists[f].name,type:"hiddenValue"});if(a.playerData.config.plugins&&a.playerData.config.plugins.playlistAPI){var g=a.playerData.config.plugins.playlistAPI;g["kpl"+a.additionalPlaylists.length+"Id"]&&(delete g["kpl"+a.additionalPlaylists.length+"Id"],delete g["kpl"+a.additionalPlaylists.length+"Name"])}a.propertyChanged(b,c)}}]),KMCMenu.controller("relatedCtrl",["$scope",function(a){if(a.relatedOption="relatedToEntry",a.entryList="",a.playlistId={id:"",text:""},a.playerData.config.plugins&&a.playerData.config.plugins.related){var b=a.playerData.config.plugins.related;b.entryList&&""!==b.entryList&&(a.relatedOption="entryList",a.entryList=b.entryList),b.playlistId&&""!==b.playlistId&&(a.relatedOption="playlistId",a.playlistId=b.playlistId)}a.entryListChange=function(){a.playerData.config.plugins.related.playlistId=null,a.playlistId={id:"",text:""},a.playerData.config.plugins.related.entryList=a.entryList},a.playlistIdChange=function(){a.playerData.config.plugins.related.entryList=null,a.entryList="",a.playerData.config.plugins.related.playlistId=a.playlistId.id},a.relatedSelected=function(){a.playerData.config.plugins.related.playlistId=void 0,a.playerData.config.plugins.related.entryList=null,a.playlistId={id:"",text:""},a.entryList="",a.propertyChanged("related",!0)},a.getLabel=function(b,c){for(var d="playlistSelectBox"==c?a.userPlaylists:a.userEntries,e=0;e<d.length;e++)if(d[e].id===b)return d[e].text;return b}}]);var KMCServices=angular.module("KMC.services",[]);KMCServices.config(["$httpProvider",function(a){a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"]}]),KMCServices.factory("apiCache",["$cacheFactory",function(a){return a("apiCache",{capacity:10})}]),KMCServices.factory("select2Svc",["$timeout",function(a){var b={getConfig:function(b,c){var d={allowClear:!1,width:"100%",initSelection:function(a,b){b($(a).data("$ngModelController").$modelValue)},query:function(d){var e=null,f={results:[]};return d.term?(e&&a.cancel(e),e=a(function(){c(d.term).then(function(a){return angular.forEach(a.objects,function(a){f.results.push({id:a.id,text:a.name})}),e=null,d.callback(f)})},200),d.callback(f),void 0):d.callback({results:b})}};return d}};return b}]),KMCServices.factory("utilsSvc",["$modal",function(a){var b={str2val:function(a){if("string"!=typeof a)return a;var b=a;return"true"===a.toLowerCase()&&(b=!0),"false"===a.toLowerCase()&&(b=!1),isNaN(parseFloat(a))||parseFloat(a).toString().length!==a.length||(b=parseFloat(a)),b},alert:function(b,c){var d=a.open({templateUrl:"templates/message.html",controller:"ModalInstanceCtrl",resolve:{settings:function(){return{title:b,message:c,buttons:[{result:!0,label:"OK",cssClass:"btn-primary"}]}}}});return d},confirm:function(b,c,d){var e=a.open({templateUrl:"templates/message.html",controller:"ModalInstanceCtrl",resolve:{settings:function(){return{title:b,message:c,buttons:[{result:!1,label:"Cancel",cssClass:"btn-default"},{result:!0,label:d,cssClass:"btn-primary"}]}}}});return e},userInput:function(b,c,d,e){var f=a.open({templateUrl:"templates/inputWindow.html",controller:"ModalInstanceInputCtrl",resolve:{settings:function(){return{title:b,inputStyle:e?e:{},message:c,buttons:[{result:!1,label:"Cancel",cssClass:"btn-default"},{result:!0,label:d,cssClass:"btn-primary"}]}}}});return f}};return b}]),KMCServices.factory("sortSvc",[function(){var a={},b={},c=function(b){this.name=b,this.elements=[],a[b]=this};return c.prototype.addElement=function(a){this.elements.push(a)},c.prototype.callObjectsUpdate=function(){angular.forEach(this.elements,function(a){cl(a.sortVal+" "+a.model)})},c.prototype.removeElement=function(a){var b=this.elements.indexOf(a);-1!=b&&this.elements.splice(b,1)},b.sortScope="",b.register=function(b,d){var e="undefined"==typeof a[b]?new c(b):a[b];e.addElement(d)},b.update=function(d,e,f){var g=a[e],h=a[d]?a[d]:new c(d);g&&g.removeElement(f),h.addElement(f),"object"==typeof b.sortScope&&b.sortScope.$broadcast("sortContainersChanged")},b.getObjects=function(){return a},b.saveOrder=function(b){a=b,angular.forEach(a,function(a){a.callObjectsUpdate()})},b}]),KMCServices.factory("PlayerService",["$http","$modal","$log","$q","apiService","$filter","localStorageService","$location","utilsSvc",function(a,b,c,d,e,f,g,h,i){var j,k,l={},m={},n=null,o=!1,p="",q=function(){s.refreshNeeded=!1,n.resolve(!0),n=null,o&&(o=!1,r()),logTime("renderPlayerDone")},r=function(){if(n)o=!0;else{n=d.defer();try{s.renderPlayer(q)}catch(a){n.reject(a)}}return n.promise},s={autoRefreshEnabled:!1,clearCurrentRefresh:function(){n=null},refreshNeeded:!1,getCurrentRefresh:function(){return n},clearCurrentPlayer:function(){m={}},setPreviewEntry:function(a){g.set("previewEntry",a),j=a.id,k=a},getPreviewEntry:function(){return j?k:g.get("previewEntry")},renderPlayer:function(a,b,c,d){logTime("renderPlayer"),$("#Comp_300x250").empty(),$("#Comp_728x90").empty(),window.mw.setConfig("forceMobileHTML5",!0),window.mw.setConfig("Kaltura.EnableEmbedUiConfJs",!0),kWidget.embed({targetId:"kVideoTarget",wid:"_"+a,uiconf_id:b,flashvars:c,entry_id:d,readyCallback:function(){$("#kVideoTarget_ifp").contents().find('link[href$="playList.css"]').clone().appendTo($("head"))}})},setKDPAttribute:function(a,b){var c=document.getElementById("kVideoTarget");if($.isFunction(c.setKDPAttribute)&&"undefined"!=typeof a&&-1!=a.indexOf(".")){var d=a.split(".")[0],e=a.split(".")[1];c.setKDPAttribute(d,e,b)}},playerRefresh:r,newPlayer:function(){var a=d.defer();return s.getDefaultConfig().success(function(b){var c;c=window.parent&&window.parent.kmc&&window.parent.kmc.vars&&window.parent.kmc.vars.default_kdp?{service:"multirequest",action:null,"1:service":"uiconf","1:action":"clone","1:id":window.parent.kmc.vars.default_kdp.id,"2:service":"uiconf","2:action":"update","2:id":"{1:result:id}","2:uiConf:name":"New Player","2:uiConf:objectType":"KalturaUiConf","2:uiConf:objType":1,"2:uiConf:width":560,"2:uiConf:height":395,"2:uiConf:tags":"html5studio,player","2:uiConf:html5Url":"/html5/html5lib/v"+window.MWEMBED_VERSION+"/mwEmbedLoader.php","2:uiConf:creationMode":2,"2:uiConf:config":angular.toJson(b)}:{service:"uiConf",action:"add","uiConf:objectType":"KalturaUiConf","uiConf:objType":1,"uiConf:description":"","uiConf:height":"395","uiConf:width":"560","uiConf:swfUrl":"/flash/kdp3/v3.9.8/kdp3.swf","uiConf:fUrlVersion":"3.9.8","uiConf:version":"161","uiConf:name":"New Player","uiConf:tags":"html5studio,player","uiConf:html5Url":"/html5/html5lib/v"+window.MWEMBED_VERSION+"/mwEmbedLoader.php","uiConf:creationMode":2,"uiConf:confFile":p,"uiConf:config":angular.toJson(b)},e.setCache(!1),e.doRequest(c).then(function(b){var c=$.isArray(b)?b[1]:b;c.autoUpdate=!0,s.setCurrentPlayer(c),e.setCache(!0),g.set("tempPlayerID",c.id),a.resolve(c)},function(b){a.reject(b)})}).error(function(){cl("Error getting default player config")}),a.promise},clonePlayer:function(a){var b=d.defer(),c={service:"multirequest",action:null,"1:service":"uiconf","1:action":"clone","1:id":a.id,"2:service":"uiconf","2:action":"update","2:id":"{1:result:id}","2:uiConf:name":"Copy of "+a.name,"2:uiConf:objectType":"KalturaUiConf"};return e.doRequest(c).then(function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},getPlayer:function(a){var b=d.defer();e.setCache(!1);var c={service:"uiConf",action:"get",id:a};return e.doRequest(c).then(function(a){if("string"==typeof a.config)try{angular.fromJson(a.config),s.setCurrentPlayer(a),b.resolve(m)}catch(c){b.reject("invalid JSON config"),i.alert("Invalid Player","The player configuration object is not valid.<br>Consider deleting this player or contact support.<br>Player ID: "+a.id),h.url("/list")}}),b.promise},setCurrentPlayer:function(a){"string"==typeof a.config&&(a.config=angular.fromJson(a.config)),"undefined"!=typeof a.config&&"undefined"!=typeof a.config.plugins&&(a.config=s.addFeatureState(a.config)),m=a},addFeatureState:function(a){return angular.forEach(a.plugins,function(b,c){$.isArray(b)&&(a.plugins[c]={}),angular.isObject(a.plugins[c])&&a.plugins[c].enabled!==!1&&(a.plugins[c].enabled=!0)}),a},cachePlayers:function(a){$.isArray(a)?angular.forEach(a,function(a){l[a.id]=a}):l[a.id]=a},deletePlayer:function(a){var b=d.defer(),c=f("translate")("Delete action was rejected: ");if("undefined"==typeof a&&m&&(a=m.id),a){var g={service:"uiConf",action:"delete",id:a};e.doRequest(g).then(function(a){b.resolve(a)},function(a){b.reject(c+a)})}else b.reject(c);return b.promise},getRequiredVersion:function(){return 2},getDefaultConfig:function(){return a.get("js/services/defaultPlayer.json")},getKDPConfig:function(){a.get("js/services/kdp.xml").success(function(a){p=a})},preparePluginsDataForRender:function(a){var b=a.plugins||a;return angular.forEach(b,function(a,c){angular.isObject(a)?a.enabled&&a.enabled===!1?delete b[c]:s.preparePluginsDataForRender(a):"enabled"==c&&(b.plugin=!0,delete b[c])}),b},savePlayer:function(a){var b=d.defer(),c=angular.copy(a.config);c.plugins=s.preparePluginsDataForRender(c.plugins),c.plugins.playlistAPI&&(c.plugins.playlistAPI.kpl0Id&&delete c.plugins.playlistAPI.kpl0Id,c.plugins.playlistAPI.kpl0Name&&delete c.plugins.playlistAPI.kpl0Name),c.enviornmentConfig&&(delete c.enviornmentConfig.enabled,void 0!==c.enviornmentConfig.localizationCode&&""===c.enviornmentConfig.localizationCode&&delete c.enviornmentConfig.localizationCode,angular.equals({},c.enviornmentConfig)&&delete c.enviornmentConfig);var f={service:"uiConf",action:"update",id:a.id,"uiConf:name":a.name,"uiConf:tags":a.tags,"uiConf:height":a.height,"uiConf:width":a.width,"uiConf:description":a.description?a.description:"","uiConf:config":JSON.stringify(c,null,"	")};return 0===a.html5Url.indexOf("/html5/html5lib/")&&(f["uiConf:html5Url"]=a.autoUpdate?"/html5/html5lib/{latest}/mwEmbedLoader.php":"/html5/html5lib/v"+window.MWEMBED_VERSION+"/mwEmbedLoader.php"),e.doRequest(f).then(function(c){l[a.id]=a,m={};var d=window.parent.kmc;d&&d.preview_embed&&d.preview_embed.updateList(-1!==a.tags.indexOf("playlist")),b.resolve(c)}),b.promise},playerUpgrade:function(a,b){var c={service:"uiConf",action:"update",id:a.id,"uiConf:html5Url":b},g=d.defer(),h=f("translate")("Upgrade player action was rejected: ");return e.doRequest(c).then(function(a){g.resolve(a)},function(a){g.reject(h+a)}),g.promise},playerUpdate:function(b,h,i){var j=d.defer(),k=f("translate")("Update player action was rejected: "),l="get",m=window.kWidget.getPath()+"services.php",n={service:"upgradePlayer",uiconf_id:b.id,ks:g.get("ks")};return window.IE<10&&(n.callback="JSON_CALLBACK",l="jsonp"),a({url:m,method:l,params:n}).success(function(a){a.uiConfId&&(delete a.uiConfId,delete a.widgetId,delete a.vars.ks),i&&a.plugins.playlistAPI&&(a.plugins.playlistAPI.includeInLayout=!0);var c=-1!=b.tags.indexOf("playlist")?"playlist":"player",d={service:"uiConf",action:"update",id:b.id,"uiConf:tags":"html5studio,"+c,"uiConf:html5Url":h,"uiConf:config":angular.toJson(a).replace('"vars":','"uiVars":')};e.doRequest(d).then(function(a){j.resolve(a)},function(a){j.reject(k+a)})}).error(function(a){j.reject("Error updating UIConf: "+a),c.error("Error updating UIConf: "+a)}),j.promise}};return s}]),KMCServices.factory("requestNotificationChannel",["$rootScope",function(a){var b="_START_REQUEST_",c="_END_REQUEST_",d={customStart:null};return d.requestStarted=function(c){a.$broadcast(b,c),c&&(d.customStart=c)},d.requestEnded=function(b){if(d.customStart){if(b!=d.customStart)return;a.$broadcast(c,b),d.customStart=null}else a.$broadcast(c)},d.onRequestStarted=function(a,c){a.$on(b,function(a,b){"ignore"!=b&&c()})},d.onRequestEnded=function(a,b){a.$on(c,function(a,c){"ignore"!=c&&b()})},d}]),KMCServices.directive("canSpin",[function(){return{require:["?^loadingWidget","?^navmenu"],priority:1e3,link:function(a,b,c,d){a.target=$('<div class="spinWrapper"></div>').prependTo(b),a.spinner=null,a.spinRunning=!1,a.opts={lines:15,length:27,width:8,radius:60,corners:1,rotate:0,direction:1,color:"#000",speed:.6,trail:24,shadow:!0,hwaccel:!0,className:"spinner",zIndex:2e9,top:"auto",left:"auto"};var e=function(){a.spinner=new Spinner(a.opts).spin()};a.endSpin=function(){a.spinner&&a.spinner.stop(),a.spinRunning=!1},a.spin=function(){a.spinRunning||(null===a.spinner&&e(),a.spinner.spin(a.target[0]),a.spinRunning=!0)},angular.forEach(d,function(b){"undefined"!=typeof b&&(b.spinnerScope=a)})}}}]),KMCServices.directive("loadingWidget",["requestNotificationChannel",function(a){return{restrict:"EA",scope:{},replace:!0,controller:function(){},template:"<div class='loadingOverlay'><a can-spin></a></div>",link:function(b,c,d,e){c.hide();var f=function(){c.show(),e.spinnerScope.spin()},g=function(){c.hide(),e.spinnerScope.endSpin()};a.onRequestStarted(b,f),a.onRequestEnded(b,g)}}}]),KMCServices.factory("editableProperties",["$q","api","$http",function(a,b,c){var d=a.defer();return b.then(function(){var a="get",b=window.kWidget.getPath()+"services.php?service=studioService";window.IE<10&&(b+="&callback=JSON_CALLBACK",a="jsonp"),c[a](b).then(function(a){var b=a.data;"object"==typeof b?d.resolve(a.data):(cl("JSON parse error of playerFeatures"),d.reject(!1))},function(a){d.reject(a)})}),d.promise}]),KMCServices.factory("loadINI",["$http",function(a){var b=null;return{getINIConfig:function(){return b||(b=a.get("studio.ini",{responseType:"text",headers:{"Content-type":"text/plain"},transformResponse:function(a){var b=a.match(/widgets\.studio\.config \= \'(.*)\'/)[1];return a=angular.fromJson(b)}})),b}}}]),KMCServices.provider("api",function(){var a=angular.injector(["ng"]),b=a.get("$q"),c=null;return{$get:["loadINI",function(a){var d=b.defer();if(c)d.resolve(c);else{var e=function(a,b){var c=document.getElementsByTagName("head")[0],d=document.createElement("script");d.src=a,d.type="text/javascript",d.addEventListener?d.addEventListener("load",b,!1):d.readyState&&(d.onreadystatechange=b),c.appendChild(d)},f=function(a){var b=function(){"undefined"!=typeof kWidget&&(kWidget.api.prototype.type="POST",c=new kWidget.api,d.resolve(c))};e(a,function(){"undefined"==typeof kWidget?setTimeout(function(){b()},100):b()})},g=null;try{var h=window.parent.kmc;if(h&&h.vars&&h.vars.studio.config){var i=angular.fromJson(h.vars.studio.config);g=h.vars.api_url+"/html5/html5lib/"+i.html5_version+"/mwEmbedLoader.php",f(g)}}catch(j){cl("Could not located parent.kmc: "+j)}g||a.getINIConfig().success(function(a){var b=a.html5lib;f(b)})}return d.promise}]}}),KMCServices.factory("apiService",["api","$q","$timeout","$location","localStorageService","apiCache","requestNotificationChannel","$filter",function(a,b,c,d,e,f,g,h){var i={apiObj:a,unSetks:function(){delete i.apiObj},setKs:function(a){i.apiObj.then(function(b){b.setKs(a)})},setWid:function(a){i.getClient().then(function(b){b.wid=a})},getKey:function(a){var b="";for(var c in a)b+=a[c]+"_";return b},listMedia:function(){var a={service:"baseentry","filter:mediaTypeIn":"1,2,5,6,201","filter:objectType":"KalturaMediaEntryFilter",action:"list"};return i.doRequest(a)},searchMedia:function(a){var b={service:"baseentry",action:"list","filter:freeText":a,"filter:mediaTypeIn":"1,2,5,6,201","filter:objectType":"KalturaMediaEntryFilter",ignoreNull:"1"};return i.doRequest(b,!0)},listPlaylists:function(){var a={service:"baseentry","filter:objectType":"KalturaBaseEntryFilter","filter:typeEqual":"5",action:"list"};return i.doRequest(a)},searchPlaylists:function(a){var b={service:"baseentry",action:"list","filter:freeText":a,"filter:objectType":"KalturaBaseEntryFilter","filter:typeEqual":"5",ignoreNull:"1"};return i.doRequest(b,!0)},useCache:!0,setCache:function(a){i.useCache=a},doRequest:function(a,c){var j=b.defer(),k=i.getKey(a);return f.get(k)&&i.useCache?j.resolve(f.get(k)):(c||g.requestStarted("api"),i.apiObj.then(function(b){b.doRequest(a,function(a){if(a.code){"INVALID_KS"==a.code&&(e.remove("ks"),d.path("/login")),c||g.requestEnded("api");var b=h("translate")(a.code);j.reject(b)}else f.put(k,a),i.useCache=!0,c||g.requestEnded("api"),j.resolve(a)})})),j.promise}};return i}]),KMCServices.factory("playerTemplates",["$http",function(a){return{listSystem:function(){return a.get("http://mrjson.com/data/5263e32d85f7fef869f2a63b/template/list.json")},listUser:function(){return a.get("http://mrjson.com/data/5263e32d85f7fef869f2a63b/userTemplates/list.json")}}}]);